name: Tweet New Blog Post

on:
  push:
    branches:
      - main
    paths:
      - 'content/articles/**'

jobs:
  tweet-new-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Get last 2 commits to detect new files
      
      - name: Get new post details
        id: post_info
        run: |
          # Find new markdown files in the most recent commit
          NEW_FILE=$(git diff --name-only HEAD^ HEAD | grep 'content/articles/.*\.md$' | head -n 1)
          
          if [ -z "$NEW_FILE" ]; then
            echo "No new post found"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found new post: $NEW_FILE"
          echo "skip=false" >> $GITHUB_OUTPUT
          
          # Extract title from front matter
          TITLE=$(grep -m 1 '^title:' "$NEW_FILE" | sed 's/^title: *"*\(.*\)"*/\1/' | sed 's/"//g')
          
          # Extract the slug from filename
          FILENAME=$(basename "$NEW_FILE" .md)
          
          # Construct URL
          POST_URL="https://www.asymmetricalcollage.com/articles/$FILENAME/"
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=$POST_URL" >> $GITHUB_OUTPUT
      
      - name: Set up Python
        if: steps.post_info.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install tweepy
        if: steps.post_info.outputs.skip != 'true'
        run: pip install tweepy
      
      - name: Post to Twitter
        if: steps.post_info.outputs.skip != 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          POST_TITLE: ${{ steps.post_info.outputs.title }}
          POST_URL: ${{ steps.post_info.outputs.url }}
        run: |
          python - <<'EOF'
          import tweepy
          import os
          
          # Authenticate
          client = tweepy.Client(
              consumer_key=os.environ['TWITTER_API_KEY'],
              consumer_secret=os.environ['TWITTER_API_SECRET'],
              access_token=os.environ['TWITTER_ACCESS_TOKEN'],
              access_token_secret=os.environ['TWITTER_ACCESS_TOKEN_SECRET']
          )
          
          # Create tweet text
          title = os.environ['POST_TITLE']
          url = os.environ['POST_URL']
          
          # Format: Title + URL (Twitter will auto-shorten URL to 23 chars)
          tweet_text = f"{title}\n\n{url}"
          
          # Post tweet
          response = client.create_tweet(text=tweet_text)
          print(f"Tweet posted successfully! Tweet ID: {response.data['id']}")
          EOF
